From 03ed71f9a3278e737f91065d3a54ee148e1962b0 Mon Sep 17 00:00:00 2001
From: Olivier Roussel <olivier.roussel@inria.fr>
Date: Wed, 3 Jan 2024 17:29:11 +0100
Subject: [PATCH 1/4] Allow components to be compiled out of SOFA

---
 Sofa/GL/CMakeLists.txt         |  9 +++++++++
 Sofa/GUI/Common/CMakeLists.txt |  9 +++++++++
 Sofa/GUI/Qt/CMakeLists.txt     | 12 ++++++++++++
 3 files changed, 30 insertions(+)

diff --git a/Sofa/GL/CMakeLists.txt b/Sofa/GL/CMakeLists.txt
index c0d94be07f..1f02ba513e 100644
--- a/Sofa/GL/CMakeLists.txt
+++ b/Sofa/GL/CMakeLists.txt
@@ -3,6 +3,15 @@ project(Sofa.GL LANGUAGES CXX)
 
 set(SOFAGLSRC_ROOT "src/sofa/gl")
 
+# Detect if component is compiled outside SOFA
+if ("${CMAKE_PROJECT_NAME}" STREQUAL "${PROJECT_NAME}")
+  list(APPEND CMAKE_MODULE_PATH "${CMAKE_CURRENT_SOURCE_DIR}/../../../cmake/Modules")
+  list(APPEND CMAKE_MODULE_PATH "${CMAKE_CURRENT_SOURCE_DIR}/../framework/Config/cmake")
+  list(APPEND CMAKE_MODULE_PATH "${CMAKE_CURRENT_SOURCE_DIR}/../framework/Config/cmake/Modules")
+
+  include(SofaMacros)
+endif()
+
 sofa_find_package(OpenGL REQUIRED BOTH_SCOPES)
 sofa_find_package(GLEW BOTH_SCOPES REQUIRED)
 sofa_find_package(Sofa.Helper REQUIRED)
diff --git a/Sofa/GUI/Qt/CMakeLists.txt b/Sofa/GUI/Qt/CMakeLists.txt
index 2bb1b2d8ba..b5b0269169 100644
--- a/Sofa/GUI/Qt/CMakeLists.txt
+++ b/Sofa/GUI/Qt/CMakeLists.txt
@@ -1,6 +1,17 @@
 cmake_minimum_required(VERSION 3.12)
 project(Sofa.GUI.Qt LANGUAGES CXX)
 
+# Detect if component is compiled outside SOFA
+if ("${CMAKE_PROJECT_NAME}" STREQUAL "${PROJECT_NAME}")
+  list(APPEND CMAKE_MODULE_PATH "${CMAKE_CURRENT_SOURCE_DIR}/../../../cmake/Modules")
+  list(APPEND CMAKE_MODULE_PATH "${CMAKE_CURRENT_SOURCE_DIR}/../../framework/Config/cmake")
+  list(APPEND CMAKE_MODULE_PATH "${CMAKE_CURRENT_SOURCE_DIR}/../../framework/Config/cmake/Modules")
+
+  include(SofaMacros)
+
+  sofa_find_package(Sofa.GUI.Common REQUIRED)
+endif()
+
 # Qt dependencies
 set(QT_TARGETS "")
 set(QT_USE_IMPORTED_TARGETS 1)
@@ -318,6 +329,7 @@ add_library(${PROJECT_NAME} SHARED ${MOC_HEADER_FILES} ${HEADER_FILES} ${MOC_FIL
 # For files generated by the moc
 target_include_directories(${PROJECT_NAME} PUBLIC "$<BUILD_INTERFACE:${CMAKE_CURRENT_BINARY_DIR}>")
 
+target_link_libraries(${PROJECT_NAME} PUBLIC Sofa.GL)
 target_link_libraries(${PROJECT_NAME} PUBLIC Sofa.GUI.Common)
 target_link_libraries(${PROJECT_NAME} PUBLIC Sofa.Component.Visual)
 target_link_libraries(${PROJECT_NAME} PUBLIC Sofa.Component.SceneUtility)
-- 
2.34.1


From e348207b66e4e4f4731ee0b8d5585a1ce5f43b9c Mon Sep 17 00:00:00 2001
From: Olivier Roussel <olivier.roussel@inria.fr>
Date: Mon, 26 Feb 2024 17:08:37 +0100
Subject: [PATCH 2/4] Allow gui components to be compiled out of SOFA

---
 Sofa/GL/CMakeLists.txt         | 9 +++++++++
 Sofa/GUI/Common/CMakeLists.txt | 9 ---------
 Sofa/GUI/Qt/CMakeLists.txt     | 3 +++
 3 files changed, 12 insertions(+), 9 deletions(-)

diff --git a/Sofa/GL/CMakeLists.txt b/Sofa/GL/CMakeLists.txt
index 1f02ba513e..169f7df311 100644
--- a/Sofa/GL/CMakeLists.txt
+++ b/Sofa/GL/CMakeLists.txt
@@ -1,6 +1,15 @@
 cmake_minimum_required(VERSION 3.12)
 project(Sofa.GL LANGUAGES CXX)
 
+# Detect if component is compiled outside SOFA
+if ("${CMAKE_PROJECT_NAME}" STREQUAL "${PROJECT_NAME}")
+  list(APPEND CMAKE_MODULE_PATH "${CMAKE_CURRENT_SOURCE_DIR}/../../../cmake/Modules")
+  list(APPEND CMAKE_MODULE_PATH "${CMAKE_CURRENT_SOURCE_DIR}/../framework/Config/cmake")
+  list(APPEND CMAKE_MODULE_PATH "${CMAKE_CURRENT_SOURCE_DIR}/../framework/Config/cmake/Modules")
+
+  include(SofaMacros)
+endif()
+
 set(SOFAGLSRC_ROOT "src/sofa/gl")
 
 # Detect if component is compiled outside SOFA
diff --git a/Sofa/GUI/Qt/CMakeLists.txt b/Sofa/GUI/Qt/CMakeLists.txt
index b5b0269169..025ce2bc84 100644
--- a/Sofa/GUI/Qt/CMakeLists.txt
+++ b/Sofa/GUI/Qt/CMakeLists.txt
@@ -340,6 +340,9 @@ if(SOFA_DUMP_VISITOR_INFO)
 endif()
 
 if(Sofa.GL_FOUND)
+    if(SOFA_GUI_QT_ENABLE_QTVIEWER)
+      target_link_libraries(${PROJECT_NAME} PUBLIC Sofa.GL)
+    endif()
     if(SOFA_GUI_QT_ENABLE_QGLVIEWER)
         target_link_libraries(${PROJECT_NAME} PUBLIC QGLViewer)
     endif()
-- 
2.34.1


From 2b24d2c053b5fe8a92b2a10dc7ac640bd50fda2c Mon Sep 17 00:00:00 2001
From: Olivier Roussel <olivier.roussel@inria.fr>
Date: Mon, 26 Feb 2024 17:08:57 +0100
Subject: [PATCH 3/4] Allow runSofa to be compiled out of SOFA

---
 applications/projects/runSofa/CMakeLists.txt | 45 +++++++++++++-------
 1 file changed, 29 insertions(+), 16 deletions(-)

diff --git a/applications/projects/runSofa/CMakeLists.txt b/applications/projects/runSofa/CMakeLists.txt
index aed8c17235..a35a2c9129 100644
--- a/applications/projects/runSofa/CMakeLists.txt
+++ b/applications/projects/runSofa/CMakeLists.txt
@@ -1,24 +1,37 @@
 cmake_minimum_required(VERSION 3.12)
 project(runSofa)
 
-###################################
-# Generate plugin_list.conf.default
-include(cmake/GeneratePluginConfig.cmake)
-if(MSVC)
-    # plugins are located in bin/
-    set(_pluginLocation "bin")
+# Detect if component is compiled outside SOFA
+if ("${CMAKE_PROJECT_NAME}" STREQUAL "${PROJECT_NAME}")
+  list(APPEND CMAKE_MODULE_PATH "${CMAKE_CURRENT_SOURCE_DIR}/../../../cmake/Modules")
+  list(APPEND CMAKE_MODULE_PATH "${CMAKE_CURRENT_SOURCE_DIR}/../../../Sofa/framework/Config/cmake")
+  list(APPEND CMAKE_MODULE_PATH "${CMAKE_CURRENT_SOURCE_DIR}/../..//../Sofa/framework/Config/cmake/Modules")
+
+  include(SofaMacros)
+
+  sofa_find_package(Sofa.Simulation.Graph REQUIRED)
+  sofa_find_package(ZLIB)
 else()
-    # plugins are located in lib/
-    set(_pluginLocation "lib")
+  ###################################
+  # Generate plugin_list.conf.default
+  # This step is skipped if the app is compiled outside SOFA
+  include(cmake/GeneratePluginConfig.cmake)
+  if(MSVC)
+      # plugins are located in bin/
+      set(_pluginLocation "bin")
+  else()
+      # plugins are located in lib/
+      set(_pluginLocation "lib")
+  endif()
+  set(_configPluginFileName plugin_list.conf)
+  set(_defaultConfigPluginFileName "${_configPluginFileName}.default")
+  set(_defaultConfigPluginFilePath "${CMAKE_BINARY_DIR}/${_pluginLocation}/${_defaultConfigPluginFileName}")
+  sofa_generate_plugin_config(${_defaultConfigPluginFilePath})
+  message("Write Plugin list at ${_defaultConfigPluginFilePath}")
+  configure_file(${_defaultConfigPluginFilePath} ${PROJECT_BINARY_DIR}/${_defaultConfigPluginFileName} COPYONLY)
+  install(FILES "${_defaultConfigPluginFilePath}" DESTINATION ${_pluginLocation}/ COMPONENT applications)
+  ###################################
 endif()
-set(_configPluginFileName plugin_list.conf)
-set(_defaultConfigPluginFileName "${_configPluginFileName}.default")
-set(_defaultConfigPluginFilePath "${CMAKE_BINARY_DIR}/${_pluginLocation}/${_defaultConfigPluginFileName}")
-sofa_generate_plugin_config(${_defaultConfigPluginFilePath})
-message("Write Plugin list at ${_defaultConfigPluginFilePath}")
-configure_file(${_defaultConfigPluginFilePath} ${PROJECT_BINARY_DIR}/${_defaultConfigPluginFileName} COPYONLY)
-install(FILES "${_defaultConfigPluginFilePath}" DESTINATION ${_pluginLocation}/ COMPONENT applications)
-###################################
 
 sofa_find_package(Sofa.Component.Playback QUIET)
 
-- 
2.34.1


From f97a0e7e19e72527ca1a3c6a8ca2345dea54ec1a Mon Sep 17 00:00:00 2001
From: Olivier Roussel <olivier.roussel@inria.fr>
Date: Mon, 26 Feb 2024 17:09:22 +0100
Subject: [PATCH 4/4] Allow examples/share to be compiled & installed out of
 SOFA

---
 examples/CMakeLists.txt | 8 +++++++-
 1 file changed, 7 insertions(+), 1 deletion(-)

diff --git a/examples/CMakeLists.txt b/examples/CMakeLists.txt
index a3e80fcf40..59c41f81f4 100644
--- a/examples/CMakeLists.txt
+++ b/examples/CMakeLists.txt
@@ -3,4 +3,10 @@ project(SofaScenes)
 
 file(GLOB_RECURSE EXAMPLES_FILES ../*.scn ../*.pscn ../*.pyscn)
 
-add_library(${PROJECT_NAME} INTERFACE ${EXAMPLES_FILES})
\ No newline at end of file
+add_library(${PROJECT_NAME} INTERFACE ${EXAMPLES_FILES})
+
+# Detect if component is compiled outside SOFA
+if ("${CMAKE_PROJECT_NAME}" STREQUAL "${PROJECT_NAME}")
+  install(DIRECTORY . DESTINATION share/sofa/examples COMPONENT resources)
+  install(DIRECTORY ../share/ DESTINATION share/sofa COMPONENT resources)
+endif()
-- 
2.34.1

